# Use Ubuntu as base image
FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TF_VERSION=1.14.3
ENV AZURE_CLI_VERSION=2.65.0

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    unzip \
    gnupg \
    software-properties-common \
    apt-transport-https \
    lsb-release \
    ca-certificates \
    git \
    vim \
    jq \
    python3 \
    python3-pip \
    python3-venv \
    bash-completion \
    && rm -rf /var/lib/apt/lists/*

# Install Azure CLI
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# Install AWS CLI v2
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"; \
    elif [ "$ARCH" = "aarch64" ]; then \
    curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"; \
    else \
    echo "Unsupported architecture: $ARCH"; exit 1; \
    fi && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip aws/

# Install Azure SDK for Python packages
RUN pip3 install --no-cache-dir \
    azure-identity \
    azure-mgmt-resource \
    azure-mgmt-compute \
    azure-mgmt-storage \
    azure-mgmt-keyvault \
    azure-mgmt-network \
    azure-mgmt-subscription \
    azure-storage-blob \
    azure-storage-file-share \
    azure-storage-queue \
    azure-keyvault-secrets \
    azure-keyvault-keys \
    azure-keyvault-certificates

# Install AWS SDK for Python (boto3)
RUN pip3 install --no-cache-dir \
    boto3 \
    botocore \
    awscli-local

# RUN az extension add --name azure-cli-ml
# Install Terraform
RUN wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip \
    && unzip terraform_${TF_VERSION}_linux_amd64.zip \
    && mv terraform /usr/local/bin/ \
    && rm terraform_${TF_VERSION}_linux_amd64.zip

# Install Kubectl
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
    KUBECTL_ARCH="amd64"; \
    elif [ "$ARCH" = "aarch64" ]; then \
    KUBECTL_ARCH="arm64"; \
    else \
    echo "Unsupported architecture: $ARCH"; exit 1; \
    fi && \
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/${KUBECTL_ARCH}/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/

# Install Helm
RUN curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
    chmod 700 get_helm.sh && \
    ./get_helm.sh && \
    rm get_helm.sh

# Create working directory
WORKDIR /workspace

# Create directories for persistent data
RUN mkdir -p /root/.azure /root/.terraform.d

# Set up bash completion for Azure CLI and Terraform
RUN echo 'source /etc/bash_completion.d/azure-cli' >> /root/.bashrc
RUN terraform -install-autocomplete

# Default command
CMD ["bash"]